//@version=5
indicator("Signal Strategy 15m Gold Relaxed", overlay=true)

plotcandle(open, high, low, close, 
     color=close > open ? color.new(color.green, 70) : color.new(color.red, 70),
     wickcolor=color.new(color.gray, 70),
     bordercolor=color.new(color.gray, 70))


// === INPUTS ===
ema_fast_len = input.int(8, "EMA Fast", minval=1)
ema_slow_len = input.int(21, "EMA Slow", minval=1)

// signal lives for the full 4h trade window (4h / 15m = 16 bars)
signal_valid_bars = input.int(16, "Signal Valid Bars", minval=1)

ema_fast = ta.ema(close, ema_fast_len)
ema_slow = ta.ema(close, ema_slow_len)
ema_gap = ema_fast - ema_slow

// === ENTRY CONDITIONS ===
// no gap filter â€” maximum sensitivity, trend filter handles noise
long_cond = ta.crossover(ema_fast, ema_slow)
short_cond = ta.crossunder(ema_fast, ema_slow)

// === SIGNAL MANAGEMENT ===
var int bars_since_signal = 0
var int last_signal = 0
var float entry_price = na

if long_cond
    last_signal := 1
    bars_since_signal := 0
    entry_price := close
else if short_cond
    last_signal := -1
    bars_since_signal := 0
    entry_price := close
else
    bars_since_signal += 1

active_signal = bars_since_signal <= signal_valid_bars ? last_signal : 0

// === VISUALIZATION ===
line_color = active_signal == 1 ? color.green : active_signal == -1 ? color.red : color.gray

plot(ema_fast, "EMA Fast", color=color.new(color.blue, 50), linewidth=1)
plot(ema_slow, "EMA Slow", color=color.new(color.orange, 50), linewidth=1)

plotshape(long_cond, "Long", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(short_cond, "Short", shape.triangledown, location.abovebar, color.red, size=size.small)

plot(close, "Active Signal", color=line_color, linewidth=6)

// === OUTPUTS FOR BOT ===
plot(close, "Close", display=display.data_window)
plot(active_signal, "Signal", display=display.data_window)
plot(ema_fast, "EmaFast", display=display.data_window)
plot(ema_slow, "EmaSlow", display=display.data_window)
plot(ema_gap, "EmaGap", display=display.data_window)
plot(bars_since_signal, "BarsSinceSignal", display=display.data_window)
plot(last_signal, "LastSignal", display=display.data_window)
